using KeyboardHookReceiver.Dto;
using Npgsql;

namespace KeyboardHookReceiver.Repository;

public class Repository : IRepository
{
    private readonly string _connectionString;

    public Repository(string connectionString)
    {
        _connectionString = connectionString;
    }

    public async Task CreateTableByAccountNameAsync(string accountName)
    {
        await using var conn = new NpgsqlConnection(_connectionString);
        await conn.OpenAsync();

        await using var cmd = new NpgsqlCommand { Connection = conn };

        cmd.CommandText = $"CREATE TABLE IF NOT EXISTS {accountName} " +
                          "(id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, " +
                          "time time," +
                          "program varchar," +
                          "keyCode smallint," +
                          "click varchar(30))";

        await cmd.ExecuteNonQueryAsync();

        await conn.CloseAsync();
    }

    public async Task AddKeyboardLogToTableAsync(KeyboardInputDto log)
    {
        await using var conn = new NpgsqlConnection(_connectionString);
        await conn.OpenAsync();

        await using var cmd = new NpgsqlCommand { Connection = conn };

        cmd.CommandText = $"INSERT INTO {log.AccountName} (time, program, keyCode, click) VALUES " +
                          $"('{log.Time}', '{log.Program}', {log.KeyCode}, null)";

        await cmd.ExecuteNonQueryAsync();

        await conn.CloseAsync();
    }

    public async Task AddMouseLogToTableAsync(MouseClickPosInputDto log)
    {
        await using var conn = new NpgsqlConnection(_connectionString);
        await conn.OpenAsync();

        await using var cmd = new NpgsqlCommand { Connection = conn };

        cmd.CommandText = $"INSERT INTO {log.AccountName} (time, program, keyCode, click) VALUES " +
                          $"('{log.Time}', '{log.Program}', null, '{log.clickSide}Click [{log.X}, {log.Y}]')";

        await cmd.ExecuteNonQueryAsync();

        await conn.CloseAsync();
    }
}